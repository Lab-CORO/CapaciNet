---
title: Architecture RefactorÃ©e - Base Placement Plugin
---
graph TB
    subgraph User["ğŸ‘¤ Utilisateur"]
        user_rviz["Interface RViz"]
        user_cli["CLI / Scripts"]
    end

    subgraph RViz["ğŸ–¼ï¸ RViz2 Plugin (UI Layer)"]
        add_waypoint["AddWayPoint<br/>(RViz Panel)<br/>â”â”â”â”â”â”â”â”<br/>ğŸ¯ DÃ©finir waypoints<br/>ğŸ–±ï¸ Marqueurs interactifs"]
        widget["BasePlacementWidget<br/>(Qt Widget)<br/>â”â”â”â”â”â”â”â”<br/>âš™ï¸ Configuration UI<br/>ğŸ“Š Affichage rÃ©sultats"]

        subgraph ROS2Clients["ROS2 Clients"]
            action_client["Action Client<br/>find_base"]
            srv_clients["Service Clients<br/>â”â”â”â”â”â”â”â”<br/>â€¢ update_reachability_map<br/>â€¢ get_union_map<br/>â€¢ update_parameters<br/>â€¢ add_named_pose<br/>â€¢ remove_named_pose<br/>â€¢ clear_maps<br/>â€¢ get_base_poses"]
        end
    end

    subgraph Interfaces["ğŸ“¡ ROS2 Interfaces<br/>(base_placement_interfaces)"]
        subgraph Messages["ğŸ“¨ Messages"]
            ws_sphere_msg["WsSphere.msg"]
            workspace_msg["WorkSpace.msg"]
            pose_named_msg["PoseNamed.msg"]
        end

        subgraph Services["ğŸ”§ Services (7)"]
            srv_update_reach["UpdateReachabilityMap"]
            srv_union["GetUnionMap"]
            srv_params["UpdateParameters"]
            srv_add["AddNamedPose"]
            srv_remove["RemoveNamedPose"]
            srv_clear["ClearMaps"]
            srv_get["GetBasePoses"]
        end

        subgraph Actions["âš¡ Actions"]
            action_find["FindBase<br/>â”â”â”â”â”â”â”â”<br/>Goal: task_poses, method<br/>Feedback: progress, iteration<br/>Result: base_poses, scores"]
        end
    end

    subgraph Server["ğŸ–¥ï¸ BasePlacementServer<br/>(ROS2 Node)"]
        server_node["BasePlacementServer<br/>â”â”â”â”â”â”â”â”<br/>ğŸ“¡ Action Server<br/>ğŸ”§ 7 Service Servers<br/>âš™ï¸ Threading Manager"]

        subgraph ServerComponents["Composants Serveur"]
            action_server["Action Server<br/>find_base"]
            service_servers["Service Servers<br/>(7 services)"]
        end
    end

    subgraph Core["ğŸ§  Computation Engine<br/>(Pure C++ - No Qt/RViz)"]
        core_class["BasePlacementCore<br/>â”â”â”â”â”â”â”â”<br/>ğŸ’¾ Reachability Data<br/>ğŸ“ Task Poses (named)<br/>ğŸ—ºï¸ Union Maps<br/>ğŸ“Š Results"]

        subgraph Algorithms["5 Algorithmes de Placement"]
            algo1["1ï¸âƒ£ PCA<br/>Principal Component Analysis"]
            algo2["2ï¸âƒ£ Grasp Reachability Score<br/>Score d'accessibilitÃ©"]
            algo3["3ï¸âƒ£ IK Solution Score<br/>CinÃ©matique inverse"]
            algo4["4ï¸âƒ£ Vertical Robot Model<br/>Alignement vertical"]
            algo5["5ï¸âƒ£ User Intuition<br/>Guidage manuel"]
        end

        subgraph CoreData["DonnÃ©es Internes"]
            reach_data["Reachability Maps<br/>IRM & RM"]
            poses_data["Named Poses<br/>map<string, Pose>"]
            union_data["Union Maps<br/>Spheres + Scores"]
            results_data["Computed Results<br/>base_poses + scores"]
        end
    end

    subgraph Utils["ğŸ“ BibliothÃ¨ques Utilitaires"]
        sphere_disc["SphereDiscretization<br/>â”â”â”â”â”â”â”â”<br/>ğŸ”® Fibonacci<br/>ğŸŒ€ ArchimÃ¨de<br/>ğŸ“Š PCA<br/>ğŸ—ºï¸ OctoMap"]
        create_marker["CreateMarker<br/>â”â”â”â”â”â”â”â”<br/>ğŸ¨ Visualisation<br/>ğŸ¤– ModÃ¨les robots"]
    end

    subgraph External["ğŸ”— Services Externes"]
        ik_service["IK Service<br/>(curobo_msgs)<br/>â”â”â”â”â”â”â”â”<br/>ğŸ¦¾ CinÃ©matique inverse"]
        tf2["TF2<br/>â”â”â”â”â”â”â”â”<br/>ğŸ”„ Transformations"]
    end

    subgraph Storage["ğŸ’¾ Stockage"]
        hdf5_files["Fichiers HDF5<br/>â”â”â”â”â”â”â”â”<br/>ğŸ“Š Reachability Maps<br/>(IRM & RM)"]
    end

    %% ============================================================
    %% CONNEXIONS UTILISATEUR
    %% ============================================================
    user_rviz -->|Interaction UI| add_waypoint
    user_rviz -->|Configuration| widget
    user_cli -->|CLI Commands| Interfaces

    %% ============================================================
    %% CONNEXIONS RVIZ â†’ CLIENTS ROS2
    %% ============================================================
    add_waypoint --> action_client
    add_waypoint --> srv_clients
    widget --> action_client
    widget --> srv_clients

    %% ============================================================
    %% CONNEXIONS CLIENTS â†’ INTERFACES
    %% ============================================================
    action_client -.->|Goal/Feedback/Result| action_find
    srv_clients -.->|Requests/Responses| Services

    %% ============================================================
    %% CONNEXIONS INTERFACES â†’ SERVEUR
    %% ============================================================
    action_find -.->|Action Protocol| action_server
    Services -.->|Service Protocol| service_servers

    %% ============================================================
    %% CONNEXIONS SERVEUR â†’ CORE
    %% ============================================================
    action_server -->|execute_find_base()| core_class
    service_servers -->|Appels mÃ©thodes| core_class

    %% ============================================================
    %% CONNEXIONS CORE â†’ ALGORITHMES
    %% ============================================================
    core_class --> algo1
    core_class --> algo2
    core_class --> algo3
    core_class --> algo4
    core_class --> algo5

    %% ============================================================
    %% CONNEXIONS CORE â†’ DONNÃ‰ES
    %% ============================================================
    core_class --> reach_data
    core_class --> poses_data
    core_class --> union_data
    core_class --> results_data

    %% ============================================================
    %% CONNEXIONS CORE â†’ UTILS
    %% ============================================================
    core_class --> sphere_disc
    algo1 --> sphere_disc
    algo2 --> sphere_disc

    %% ============================================================
    %% CONNEXIONS VISUALISATION
    %% ============================================================
    add_waypoint --> create_marker
    widget --> create_marker

    %% ============================================================
    %% CONNEXIONS EXTERNES
    %% ============================================================
    core_class -.->|IK Requests| ik_service
    core_class --> tf2
    algo3 -.->|IK Validation| ik_service

    %% ============================================================
    %% CONNEXIONS STOCKAGE
    %% ============================================================
    core_class -.->|Load HDF5| hdf5_files
    srv_update_reach -.->|File path| hdf5_files

    %% ============================================================
    %% FEEDBACK LOOP (ACTION)
    %% ============================================================
    algo2 -.->|Feedback Callback| action_server
    algo3 -.->|Feedback Callback| action_server
    action_server -.->|Publish Feedback| action_find
    action_find -.->|Feedback Stream| action_client
    action_client -.->|Update UI| widget

    %% ============================================================
    %% ANNOTATIONS
    %% ============================================================
    note1[/"âœ… SÃ©paration claire:<br/>UI â†” ROS2 â†” Calcul"/]
    note2[/"ğŸ“Š Feedback temps rÃ©el<br/>via Action ROS2"/]
    note3[/"ğŸ”„ RÃ©utilisable:<br/>BasePlacementCore<br/>sans dÃ©pendances UI"/]

    note1 -.-> Server
    note2 -.-> action_find
    note3 -.-> Core

    %% ============================================================
    %% STYLES
    %% ============================================================
    classDef uiClass fill:#e1f5ff,stroke:#0288d1,stroke-width:3px
    classDef interfaceClass fill:#fff3e0,stroke:#f57c00,stroke-width:3px
    classDef serverClass fill:#f3e5f5,stroke:#7b1fa2,stroke-width:3px
    classDef coreClass fill:#e8f5e9,stroke:#388e3c,stroke-width:3px
    classDef algoClass fill:#fff9c4,stroke:#f9a825,stroke-width:2px
    classDef dataClass fill:#fce4ec,stroke:#c2185b,stroke-width:2px
    classDef utilClass fill:#e0e0e0,stroke:#616161,stroke-width:2px
    classDef externalClass fill:#e3f2fd,stroke:#1976d2,stroke-width:2px,stroke-dasharray: 5 5
    classDef noteClass fill:#fffde7,stroke:#f57f17,stroke-width:2px

    class add_waypoint,widget,action_client,srv_clients uiClass
    class ws_sphere_msg,workspace_msg,pose_named_msg,srv_update_reach,srv_union,srv_params,srv_add,srv_remove,srv_clear,srv_get,action_find interfaceClass
    class server_node,action_server,service_servers serverClass
    class core_class coreClass
    class algo1,algo2,algo3,algo4,algo5 algoClass
    class reach_data,poses_data,union_data,results_data dataClass
    class sphere_disc,create_marker utilClass
    class ik_service,tf2,hdf5_files externalClass
    class note1,note2,note3 noteClass
